!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.DHClient=t()}(this,function(){var e=function(){"use strict";var e={isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},inArray:function(e,t,n){if(t){if(Array.prototype.indexOf)return t.indexOf(e,n);var r=t.length,i=+n||0;if(!r||i>=r)return-1;for(i=0>i?Math.max(0,r+i):i;r>i;i++)if(i in t&&t[i]===e)return i;return-1}},forEach:function(e,t){var n;if(this.isArray(e)){var r=e.length;for(n=0;r>n&&t.call(e[n],n,e[n])!==!1;n++);}else for(n in e)if(e.hasOwnProperty(n)&&t.call(e[n],n,e[n])===!1)break;return e},toArray:function(e){if(!e)return null;for(var t=[],n=0,r=e.length;r>n;n++)t.push(e[n]);return t},parseDate:function(e){return new Date(e.substring(0,4),parseInt(e.substring(5,7),10)-1,e.substring(8,10),e.substring(11,13),e.substring(14,16),e.substring(17,19),e.substring(20,23))},formatDate:function(t){if(e.isString(t))return t;if("[object Date]"!==Object.prototype.toString.call(t))throw new Error("Invalid object type");var n=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return t.getUTCFullYear()+"-"+n(t.getUTCMonth()+1)+"-"+n(t.getUTCDate())+"T"+n(t.getUTCHours())+":"+n(t.getUTCMinutes())+":"+n(t.getUTCSeconds())+"."+n(t.getUTCMilliseconds(),3)},encodeBase64:function(e){var t,n,r,i,a,s,o,c,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,h=0,d="",f=[];if(!e)return e;do t=e.charCodeAt(l++),n=e.charCodeAt(l++),r=e.charCodeAt(l++),c=t<<16|n<<8|r,i=c>>18&63,a=c>>12&63,s=c>>6&63,o=63&c,f[h++]=u.charAt(i)+u.charAt(a)+u.charAt(s)+u.charAt(o);while(l<e.length);d=f.join("");var p=e.length%3;return(p?d.slice(0,p-3):d)+"===".slice(p||3)},noop:function(){},createCallback:function(e){return e&&"[object Function]"===Object.prototype.toString.call(e)?e:this.noop},isGuid:function(e){return e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},serializeQuery:function(e){var t,n,r="";for(t in e)e.hasOwnProperty(t)&&(""!=r&&(r+="&"),n=e[t],n=null==n?"":n,r+=encodeURIComponent(t)+"="+encodeURIComponent(n));return r},makeUrl:function(t){var n=t.method,r=t.url,i=t.data;return"GET"===n&&i&&(i=e.serializeQuery(i),i&&(r+=(-1!=r.indexOf("?")?"&":"?")+i)),r},serverErrorMessage:function(e){var t="DeviceHive server error";if(e.responseText)try{t+=" - "+JSON.parse(e.responseText).message}catch(n){t+=" - "+e.responseText}return{error:t}},errorMessage:function(e){return{error:"DeviceHive error: "+e}},setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)}};return e}(),t=function(){"use strict";var t=function(){};return t.prototype={bind:function(e,t,n){this._handlers||(this._handlers={});var r=this._handlers[e]||(this._handlers[e]=[]);return r.push({callback:t,context:n||this}),this},unbind:function(t,n){if(!t&&!n)return this._handlers=null,this;var r=this._handlers[t];if(!r)return this;if(!n)return delete this._handlers[t],this;var i=[];return e.forEach(r,function(e,t){n&&n!==t.callback&&i.push(t)}),i.length?this._handlers[t]=i:delete this._handlers[t],this},trigger:function(t){if(!this._handlers)return this;var n=e.toArray(arguments).slice(1),r=this._handlers[t];return r&&this._triggerEvents(r,n),this},_triggerEvents:function(t,n){e.forEach(t,function(e,t){t.callback.apply(t.context,n)})}},t}(),n=function(){"use strict";var t=e.noop();if(t="undefined"!=typeof XMLHttpRequest?function(){return new XMLHttpRequest}:function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}},!t())throw new Error("DeviceHive: XMLHttpRequest is not available");return{send:function(n,r){n.method=n.method||"GET",r=e.createCallback(r);var i=t(),a=n.headers,s=e.makeUrl(n),o=n.method;if(i.open(o,s,!0),("POST"==o||"PUT"==o)&&(i.setRequestHeader("Content-Type","application/json"),n.data=JSON.stringify(n.data)),i.onreadystatechange=function(){var t,n;if(4===i.readyState){t=i.status&&i.status>=200&&i.status<300||304===i.status,t||(n=e.serverErrorMessage(i));var a=i.responseText?JSON.parse(i.responseText):null;return r(n,a)}},a)for(var c in a)void 0!==a[c]&&i.setRequestHeader(c,a[c]);return i.send(n.data||void 0),{abort:function(){i.abort()}}}}}(),r=function(){"use strict";var t={USER:1,KEY:2,DEVICE:4},r=function(e,t){return(e&t)==t},i=function(n,i){var a=i.authTypes,s=i.auth;if(n.headers=i.headers||{},a){if(!s)throw new Error("Authentication parameters must be specified for this endpoint. Endpoint auth code: "+a);if(r(a,t.KEY)&&s.accessKey)n.headers.Authorization="Bearer "+s.accessKey;else if(r(a,t.DEVICE)&&e.isGuid(s.deviceId)&&e.isGuid(s.deviceKey))n.headers["Auth-DeviceID"]=s.deviceId,n.headers["Auth-DeviceKey"]=s.deviceKey;else{if(!r(a,t.USER))throw new Error("Invalid authentication parameters. Endpoint auth code: "+a);n.headers.Authorization="Basic "+e.encodeBase64(s.login+":"+s.password)}}},a=function(e,t){var r={method:e.method,url:e.base+e.relative,data:e.data};return i(r,e,t),n.send(r,t)};return{info:function(e,t){return a({base:e,relative:"/info",method:"GET"},t)},getAccessKeys:function(e,n,r,i){return a({base:e,relative:"/user/"+r+"/accesskey",method:"GET",authTypes:t.USER,auth:n},i)},getAccessKey:function(e,n,r,i,s){return a({base:e,relative:"/user/"+r+"/accesskey/"+r,method:"GET",authTypes:t.USER,auth:n},s)},insertAccessKey:function(e,n,r,i,s){return a({base:e,relative:"/user/"+r+"/accesskey",data:i,method:"POST",authTypes:t.USER,auth:n},s)},updateAccessKey:function(e,n,r,i,s,o){return a({base:e,relative:"/user/"+r+"/accesskey/"+i,data:s,method:"PUT",authTypes:t.USER,auth:n},o)},deleteAccessKey:function(e,n,r,i,s){return a({base:e,relative:"/user/"+r+"/accesskey/"+i,method:"DELETE",authTypes:t.USER,auth:n},s)},getDevices:function(e,n,r,i){return a({base:e,relative:"/device",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getDevice:function(e,n,r,i){return a({base:e,relative:"/device/"+r,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},i)},getEquipmentState:function(e,n,r,i){return a({base:e,relative:"/device/"+r+"/equipment",method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},registerDevice:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r,method:"PUT",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},getDeviceClass:function(e,n,r,i){return a({base:e,relative:"/device/class/"+r,method:"GET",authTypes:t.USER,auth:n},i)},getCommands:function(n,r,i,s,o){return s&&s.start&&(s.start=e.formatDate(s.start)),s&&s.end&&(s.end=e.formatDate(s.end)),a({base:n,relative:"/device/"+i+"/command",method:"GET",data:s,authTypes:t.USER|t.KEY|t.DEVICE,auth:r},o)},getCommand:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/command/"+i,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},insertCommand:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/command",method:"POST",data:i,authTypes:t.USER|t.KEY,auth:n},s)},updateCommand:function(e,n,r,i,s,o){return a({base:e,relative:"/device/"+r+"/command/"+i,method:"PUT",data:s,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},pollCommands:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/command/poll",method:"GET",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},pollManyCommands:function(e,n,r,i){return a({base:e,relative:"/device/command/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},waitCommandResult:function(e,n,r,i,s,o){return a({base:e,relative:"/device/"+r+"/command/"+i+"/poll",method:"GET",data:s,authTypes:t.USER|t.KEY,auth:n},o)},getNotifications:function(n,r,i,s,o){return s&&s.start&&(s.start=e.formatDate(s.start)),s&&s.end&&(s.end=e.formatDate(s.end)),a({base:n,relative:"/device/"+i+"/notification",method:"GET",data:s,authTypes:t.USER|t.KEY,auth:r},o)},getNotification:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/notification/"+i,method:"GET",authTypes:t.USER|t.KEY,auth:n},s)},insertNotification:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/notification",method:"POST",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},pollNotifications:function(e,n,r,i,s){return a({base:e,relative:"/device/"+r+"/notification/poll",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},s)},pollManyNotifications:function(e,n,r,i){return a({base:e,relative:"/device/notification/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetworks:function(e,n,r,i){return a({base:e,relative:"/network",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetwork:function(e,n,r,i){return a({base:e,relative:"/network/"+r,method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},insertNetwork:function(e,n,r,i){return a({base:e,relative:"/network",method:"POST",data:r,authTypes:t.USER,auth:n},i)},updateNetwork:function(e,n,r,i,s){return a({base:e,relative:"/network/"+r,method:"PUT",data:i,authTypes:t.USER,auth:n},s)},deleteNetwork:function(e,n,r,i){return a({base:e,relative:"/network/"+r,method:"DELETE",authTypes:t.USER,auth:n},i)},getCurrentUser:function(e,n,r){return a({base:e,relative:"/user/current",method:"GET",authTypes:t.USER,auth:n},r)},updateCurrentUser:function(e,n,r,i){return a({base:e,relative:"/user/current",method:"PUT",data:r,authTypes:t.USER,auth:n},i)}}}(),i=function(){"use strict";var n=function(e,n,r){return r=r||e.channelState,r===e.channelState?(e.channelState=n,e._events=e._events||new t,e._events.trigger("onChannelStateChanged",{oldState:r,newState:n}),!0):!1},a={disconnected:0,connecting:1,connected:2};return i={channelStates:a,channelState:a.disconnected,openChannel:function(t,i){function a(r){s.serverInfo=r,i?e.isArray(i)||(i=[i]):(i=[],e.forEach(s._channels,function(e){i.push(e)}));var a=!0;!function o(r){e.forEach(r,function(i){var c=this;return s._channels[c]?(s._channel=new s._channels[c](s),s._channel.open(function(a){if(a){var u=r.slice(++i);if(!u.length)return t(e.errorMessage("Cannot open any of the specified channels"));o(u)}else n(s,s.channelStates.connected),t(null,c)}),a=!1):void 0})}(i),a&&t(e.errorMessage("None of the specified channels are supported"))}if(t=e.createCallback(t),!n(this,this.channelStates.connecting,this.channelStates.disconnected))return void t(null);var s=this;this.serverInfo?a(this.serverInfo):r.info(this.serviceUrl,function(e,r){e?(n(s,s.channelStates.disconnected),t(e,r)):a(r)})},closeChannel:function(t){if(t=e.createCallback(t),this.channelState===this.channelStates.disconnected)return t(null);var r=this;this._channel&&this._channel.close(function(e,i){return e?t(e,i):(r._channel=null,n(r,r.channelStates.disconnected),t(null))})},channelStateChanged:function(n){n=e.createCallback(n);var r=this;return this._events=this._events||new t,this._events.bind("onChannelStateChanged",function(e){n.call(r,e)}),this},_ensureConnectedState:function(){if(this.channelState===this.channelStates.disconnected)throw new Error("DeviceHive: Channel is not opened, call the .openChannel() method first");if(this.channelState===this.channelStates.connecting)throw new Error("DeviceHive: Channel has not been initialized, use .openChannel().done() to run logic after the channel is initialized")}}}(),a=function(){"use strict";var t=function(n,r){var i={timestamp:r},a=function(i,a){if(i)n._polling&&e.setTimeout(function(){t(n,r)},1e3);else{var s=null;a&&e.forEach(a,function(){var e=n._poller.resolveTimestamp(this);(!s||e>s)&&(s=e),n._poller.onData(this)}),t(n,s||r)}};n.pollRequest=n._polling&&n._poller.executePoll(i,a)},n=function(e,t){this.serviceUrl=e,this._poller=t};return n.prototype={startPolling:function(n){n=e.createCallback(n),this.stopPolling();var i=this;return r.info(this.serviceUrl,function(e,r){return e?n(e):(i._polling=!0,t(i,r.serverTimestamp),n(null))})},stopPolling:function(){this._polling=!1,this.pollRequest&&this.pollRequest.abort()}},n}(),s=function(){"use strict";var t=e.noop;return t.requestTimeout=1e4,t.prototype={_handler:e.noop,open:function(t,n){if(n=e.createCallback(n),!WebSocket)return n(e.errorMessage("WebSockets are not supported"));var r=this,i=!1;this._native=new WebSocket(t),this._native.onopen=function(e){i=!0,n(null,e)},this._native.onmessage=function(t){var n=JSON.parse(t.data);if(r._requests&&n.requestId){var i=r._requests[n.requestId];i&&(e.clearTimeout(i.timeout),n.status&&"success"==n.status?i.cb(null,n):i.cb({error:n.error}),delete r._requests[n.requestId])}else r._handler(n)},this._native.onclose=function(t){if(!i){var r=e.errorMessage("WebSocket connection has failed to open");return r.data=t,n(r)}}},close:function(t){t=e.createCallback(t),this._native.onclose=function(e){return t(null,e)},this._native.close()},message:function(e){this._handler=e},send:function(n,r,i){i=e.createCallback(i);var a=this,s={};return this._requestId=this._requestId||0,s.id=++this._requestId,s.cb=i,s.timeout=e.setTimeout(function(){s.cb(e.errorMessage("Operation timeout")),delete a._requests[s.id]},t.requestTimeout),this._requests=this._requests||{},this._requests[s.id]=s,r=r||{},r.requestId=s.id,r.action=n,this._native.send(JSON.stringify(r)),s}},t}(),o=function(){"use strict";var e=function(e){this._transport=new s,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t.deviceGuid,t.command),"command/update"==t.action&&e.trigger("onCommandUpdate",t.command),"notification/insert"==t.action&&t.deviceGuid&&t.notification&&e.trigger("onNotification",t.deviceGuid,t.notification)})};return e.prototype={open:function(e,t){this._transport.open(e+"/client",t)},close:function(e){this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n,r){this._transport.send("authenticate",{login:e,password:t,accessKey:n},r)},sendCommand:function(e,t){this._transport.send("command/insert",e,t)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)},notificationSubscribe:function(e,t){this._transport.send("notification/subscribe",e,t)},notificationUnSubscribe:function(e,t){this._transport.send("notification/unsubscribe",e,t)}},e}(),c=function(){"use strict";var n=function(e,t,n,i){return e._executeApi(r.waitCommandResult,[t,n,null,i])};return c=function(e){this._hive=e,this._events=new t,this.deviceIds=[];var n=this;this._lp=new a(this._hive.serviceUrl,{executePoll:function(e,t){return n.deviceIds&&(e.deviceGuids=n.deviceIds.join()),n._hive._executeApi(r.pollManyNotifications,[e,t])},resolveTimestamp:function(e){return e.notification.timestamp},onData:function(e){n._events.trigger("onNotification",e.deviceGuid,e.notification)}})},c.prototype={open:function(t){return(t=e.createCallback(t))(null)},close:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},subscribe:function(t){return t=e.createCallback(t),this.deviceIds&&0===this.deviceIds.length?(this._lp.stopPolling(),t(null)):this._lp.startPolling(t)},unsubscribe:function(e){return this.subscribe(e)},sendCommand:function(t,i,a){function s(r,i){n(c._hive,t,r,function(t,n){return t=t||!n&&e.errorMessage("Cannot get command result. Wait request timed out."),t?i(t):i(null,n)})}function o(t,n){return(t=t||!n&&e.errorMessage("Error inserting a new command")||!n.id&&e.errorMessage("Cannot get inserted command id"))?a(t):(h=!0,d.command=n,a(null,n),void(l&&s(d.command.id,l)))}var c=this,u=i,l=e.noop(),h=!1,d={};return a=e.createCallback(a),this._hive._executeApi(r.insertCommand,[t,u,o]),d.result=function(e){h?s(d.id,e):l=e},d}},c}(),u=function(){"use strict";var n=function(e){this._hive=e,this._events=new t,this.deviceIds=[]};return n.prototype={open:function(t){function n(e){return e?t(e):void i._wsApi.authenticate(i._hive.auth.login,i._hive.auth.password,i._hive.auth.accessKey,function(e,n){return e?t(e):(i._events.bind("onCommandUpdate",function(e){var t=i._commandRequests[e.id];t&&(t._result=e,t._onResult(null,e),delete i._commandRequests[e.id])}),t(e,n))})}t=e.createCallback(t);var r=this._hive.serverInfo.webSocketServerUrl;if(!r)return void t(e.errorMessage("Open channel failed. Cannot get web socket server url"));var i=this;this._wsApi=new o(i._events),this._wsApi.open(r,n)},close:function(t){t=e.createCallback(t),this._wsApi.close(t)},subscribe:function(t){if(t=e.createCallback(t),this._sub)return this.unsubscribe(t);if(this.deviceIds&&0===this.deviceIds.length)return t(null);var n=this;this._wsApi.notificationSubscribe({deviceGuids:this.deviceIds},function(e,r){return n._sub=r.subscriptionId,t(e,r)})},unsubscribe:function(t){if(!this._sub)return t(null);t=e.createCallback(t);var n=this;this._wsApi.notificationUnSubscribe({subscriptionId:this._sub},function(e){return e?t(e):(n._sub=null,n.subscribe(t))})},sendCommand:function(t,n,r){function i(t,n){return t?r(t,n):n&&n.command&&n.command.id?(a._commandRequests=a._commandRequests||{},a._commandRequests[n.command.id]=o,r(null,n),void(o.command=n.command)):r(e.errorMessage("Error inserting a new command"),n)}var a=this,s={deviceGuid:t,command:n},o={};return r=e.createCallback(r),this._wsApi.sendCommand(s,i),o._onResult=e.noop,o.result=function(e){o._result&&e(null,o._result),o._onResult=e},o}},n}(),l=function(){"use strict";var t=function(e,t,n){this.serviceUrl=e,this.auth={},n?(this.auth.login=t,this.auth.password=n):this.auth.accessKey=t};return t.prototype=i,t.constructor=t,t.prototype.getNetworks=function(t,n){return n=e.createCallback(n),this._executeApi(r.getNetworks,[t,n])},t.prototype.getNetwork=function(t,n){return n=e.createCallback(n),this._executeApi(r.getNetwork,[t,n])},t.prototype.getDevices=function(t,n){return n=e.createCallback(n),this._executeApi(r.getDevices,[t,n])},t.prototype.getDevice=function(t,n){return n=e.createCallback(n),this._executeApi(r.getDevice,[t,n])},t.prototype.getDeviceClass=function(t,n){if(n=e.createCallback(n),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to get device class information");return this._executeApi(r.getDeviceClass,[t,n])},t.prototype.getEquipmentState=function(t,n){return n=e.createCallback(n),this._executeApi(r.getEquipmentState,[t,n])},t.prototype.getNotifications=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getNotifications,[t,n,i])},t.prototype.getNotification=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getNotification,[t,n,i])},t.prototype.getCommands=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getCommands,[t,n,i])},t.prototype.getCommand=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getCommand,[t,n,i])},t.prototype.getCurrentUser=function(t){if(t=e.createCallback(t),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to get current user information");return this._executeApi(r.getCurrentUser,[t])},t.prototype.updateCurrentUser=function(t,n){if(n=e.createCallback(n),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to update current user");return this._executeApi(r.updateCurrentUser,[t,n])},t.prototype.subscribe=function(t,n){n=e.createCallback(n),t&&!e.isArray(t)&&(t=[t]),this._ensureConnectedState();var r=this._channel;return t?e.forEach(t,function(){e.inArray(this.toLowerCase(),r.deviceIds)<0&&r.deviceIds.push(this.toLowerCase())}):r.deviceIds=null,r.subscribe(function(t){return n(t,e.toArray(r.deviceIds))})},t.prototype.unsubscribe=function(t,n){n=e.createCallback(n),t&&!e.isArray(t)&&(t=[t]),this._ensureConnectedState();var r=this._channel;return t?r.deviceIds&&e.forEach(t,function(){var t=e.inArray(this.toLowerCase(),r.deviceIds);t>=0&&r.deviceIds.splice(t,1)}):r.deviceIds=[],r.unsubscribe(function(t){return n(t,e.toArray(r.deviceIds))})},t.prototype.sendCommand=function(t,n,r,i){return i=e.createCallback(i),this._ensureConnectedState(),this._channel.sendCommand(t,{command:n,parameters:r},i)},t.prototype.notification=function(t){t=e.createCallback(t),this._ensureConnectedState();var n=this;return this._channel._events.bind("onNotification",function(e,r){t.call(n,e,r)}),this},t.prototype._executeApi=function(e,t){var n=[this.serviceUrl,this.auth].concat(t);return e.apply(null,n)},t.prototype._channels={},t.prototype._channels.websocket=u,t.prototype._channels.longpolling=c,t}();return l});