!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.DHDevice=t()}(this,function(){var e=function(){"use strict";var e={isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},inArray:function(e,t,n){if(t){if(Array.prototype.indexOf)return t.indexOf(e,n);var i=t.length,r=+n||0;if(!i||r>=i)return-1;for(r=0>r?Math.max(0,i+r):r;i>r;r++)if(r in t&&t[r]===e)return r;return-1}},forEach:function(e,t){var n;if(this.isArray(e)){var i=e.length;for(n=0;i>n&&t.call(e[n],n,e[n])!==!1;n++);}else for(n in e)if(e.hasOwnProperty(n)&&t.call(e[n],n,e[n])===!1)break;return e},toArray:function(e){if(!e)return null;for(var t=[],n=0,i=e.length;i>n;n++)t.push(e[n]);return t},parseDate:function(e){return new Date(e.substring(0,4),parseInt(e.substring(5,7),10)-1,e.substring(8,10),e.substring(11,13),e.substring(14,16),e.substring(17,19),e.substring(20,23))},formatDate:function(t){if(e.isString(t))return t;if("[object Date]"!==Object.prototype.toString.call(t))throw new Error("Invalid object type");var n=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return t.getUTCFullYear()+"-"+n(t.getUTCMonth()+1)+"-"+n(t.getUTCDate())+"T"+n(t.getUTCHours())+":"+n(t.getUTCMinutes())+":"+n(t.getUTCSeconds())+"."+n(t.getUTCMilliseconds(),3)},encodeBase64:function(e){var t,n,i,r,a,s,o,c,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,l=0,d="",f=[];if(!e)return e;do t=e.charCodeAt(h++),n=e.charCodeAt(h++),i=e.charCodeAt(h++),c=t<<16|n<<8|i,r=c>>18&63,a=c>>12&63,s=c>>6&63,o=63&c,f[l++]=u.charAt(r)+u.charAt(a)+u.charAt(s)+u.charAt(o);while(h<e.length);d=f.join("");var p=e.length%3;return(p?d.slice(0,p-3):d)+"===".slice(p||3)},noop:function(){},createCallback:function(e){return e&&"[object Function]"===Object.prototype.toString.call(e)?e:this.noop},isGuid:function(e){return e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},serializeQuery:function(e){var t,n,i="";for(t in e)e.hasOwnProperty(t)&&(""!=i&&(i+="&"),n=e[t],n=null==n?"":n,i+=encodeURIComponent(t)+"="+encodeURIComponent(n));return i},makeUrl:function(t){var n=t.method,i=t.url,r=t.data;return"GET"===n&&r&&(r=e.serializeQuery(r),r&&(i+=(-1!=i.indexOf("?")?"&":"?")+r)),i},serverErrorMessage:function(e){var t="DeviceHive server error";if(e.responseText)try{t+=" - "+JSON.parse(e.responseText).message}catch(n){t+=" - "+e.responseText}return{error:t}},errorMessage:function(e){return{error:"DeviceHive error: "+e}},setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)}};return e}(),t=function(){"use strict";var t=function(){};return t.prototype={bind:function(e,t,n){this._handlers||(this._handlers={});var i=this._handlers[e]||(this._handlers[e]=[]);return i.push({callback:t,context:n||this}),this},unbind:function(t,n){if(!t&&!n)return this._handlers=null,this;var i=this._handlers[t];if(!i)return this;if(!n)return delete this._handlers[t],this;var r=[];return e.forEach(i,function(e,t){n&&n!==t.callback&&r.push(t)}),r.length?this._handlers[t]=r:delete this._handlers[t],this},trigger:function(t){if(!this._handlers)return this;var n=e.toArray(arguments).slice(1),i=this._handlers[t];return i&&this._triggerEvents(i,n),this},_triggerEvents:function(t,n){e.forEach(t,function(e,t){t.callback.apply(t.context,n)})}},t}(),n=function(){"use strict";var t=e.noop();if(t="undefined"!=typeof XMLHttpRequest?function(){return new XMLHttpRequest}:function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}},!t())throw new Error("DeviceHive: XMLHttpRequest is not available");return{send:function(n,i){n.method=n.method||"GET",i=e.createCallback(i);var r=t(),a=n.headers,s=e.makeUrl(n),o=n.method;if(r.open(o,s,!0),("POST"==o||"PUT"==o)&&(r.setRequestHeader("Content-Type","application/json"),n.data=JSON.stringify(n.data)),r.onreadystatechange=function(){var t,n;if(4===r.readyState){t=r.status&&r.status>=200&&r.status<300||304===r.status,t||(n=e.serverErrorMessage(r));var a=r.responseText?JSON.parse(r.responseText):null;return i(n,a)}},a)for(var c in a)void 0!==a[c]&&r.setRequestHeader(c,a[c]);return r.send(n.data||void 0),{abort:function(){r.abort()}}}}}(),i=function(){"use strict";var t={USER:1,KEY:2,DEVICE:4},i=function(e,t){return(e&t)==t},r=function(n,r){var a=r.authTypes,s=r.auth;if(n.headers=r.headers||{},a){if(!s)throw new Error("Authentication parameters must be specified for this endpoint. Endpoint auth code: "+a);if(i(a,t.KEY)&&s.accessKey)n.headers.Authorization="Bearer "+s.accessKey;else if(i(a,t.DEVICE)&&e.isGuid(s.deviceId)&&e.isGuid(s.deviceKey))n.headers["Auth-DeviceID"]=s.deviceId,n.headers["Auth-DeviceKey"]=s.deviceKey;else{if(!i(a,t.USER))throw new Error("Invalid authentication parameters. Endpoint auth code: "+a);n.headers.Authorization="Basic "+e.encodeBase64(s.login+":"+s.password)}}},a=function(e,t){var i={method:e.method,url:e.base+e.relative,data:e.data};return r(i,e,t),n.send(i,t)};return{info:function(e,t){return a({base:e,relative:"/info",method:"GET"},t)},getAccessKeys:function(e,n,i,r){return a({base:e,relative:"/user/"+i+"/accesskey",method:"GET",authTypes:t.USER,auth:n},r)},getAccessKey:function(e,n,i,r,s){return a({base:e,relative:"/user/"+i+"/accesskey/"+i,method:"GET",authTypes:t.USER,auth:n},s)},insertAccessKey:function(e,n,i,r,s){return a({base:e,relative:"/user/"+i+"/accesskey",data:r,method:"POST",authTypes:t.USER,auth:n},s)},updateAccessKey:function(e,n,i,r,s,o){return a({base:e,relative:"/user/"+i+"/accesskey/"+r,data:s,method:"PUT",authTypes:t.USER,auth:n},o)},deleteAccessKey:function(e,n,i,r,s){return a({base:e,relative:"/user/"+i+"/accesskey/"+r,method:"DELETE",authTypes:t.USER,auth:n},s)},getDevices:function(e,n,i,r){return a({base:e,relative:"/device",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},r)},getDevice:function(e,n,i,r){return a({base:e,relative:"/device/"+i,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},r)},getEquipmentState:function(e,n,i,r){return a({base:e,relative:"/device/"+i+"/equipment",method:"GET",authTypes:t.USER|t.KEY,auth:n},r)},registerDevice:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i,method:"PUT",data:r,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},getDeviceClass:function(e,n,i,r){return a({base:e,relative:"/device/class/"+i,method:"GET",authTypes:t.USER,auth:n},r)},getCommands:function(n,i,r,s,o){return s&&s.start&&(s.start=e.formatDate(s.start)),s&&s.end&&(s.end=e.formatDate(s.end)),a({base:n,relative:"/device/"+r+"/command",method:"GET",data:s,authTypes:t.USER|t.KEY|t.DEVICE,auth:i},o)},getCommand:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/command/"+r,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},insertCommand:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/command",method:"POST",data:r,authTypes:t.USER|t.KEY,auth:n},s)},updateCommand:function(e,n,i,r,s,o){return a({base:e,relative:"/device/"+i+"/command/"+r,method:"PUT",data:s,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},pollCommands:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/command/poll",method:"GET",data:r,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},pollManyCommands:function(e,n,i,r){return a({base:e,relative:"/device/command/poll",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},r)},waitCommandResult:function(e,n,i,r,s,o){return a({base:e,relative:"/device/"+i+"/command/"+r+"/poll",method:"GET",data:s,authTypes:t.USER|t.KEY,auth:n},o)},getNotifications:function(n,i,r,s,o){return s&&s.start&&(s.start=e.formatDate(s.start)),s&&s.end&&(s.end=e.formatDate(s.end)),a({base:n,relative:"/device/"+r+"/notification",method:"GET",data:s,authTypes:t.USER|t.KEY,auth:i},o)},getNotification:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/notification/"+r,method:"GET",authTypes:t.USER|t.KEY,auth:n},s)},insertNotification:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/notification",method:"POST",data:r,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},pollNotifications:function(e,n,i,r,s){return a({base:e,relative:"/device/"+i+"/notification/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},s)},pollManyNotifications:function(e,n,i,r){return a({base:e,relative:"/device/notification/poll",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},r)},getNetworks:function(e,n,i,r){return a({base:e,relative:"/network",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},r)},getNetwork:function(e,n,i,r){return a({base:e,relative:"/network/"+i,method:"GET",authTypes:t.USER|t.KEY,auth:n},r)},insertNetwork:function(e,n,i,r){return a({base:e,relative:"/network",method:"POST",data:i,authTypes:t.USER,auth:n},r)},updateNetwork:function(e,n,i,r,s){return a({base:e,relative:"/network/"+i,method:"PUT",data:r,authTypes:t.USER,auth:n},s)},deleteNetwork:function(e,n,i,r){return a({base:e,relative:"/network/"+i,method:"DELETE",authTypes:t.USER,auth:n},r)},getCurrentUser:function(e,n,i){return a({base:e,relative:"/user/current",method:"GET",authTypes:t.USER,auth:n},i)},updateCurrentUser:function(e,n,i,r){return a({base:e,relative:"/user/current",method:"PUT",data:i,authTypes:t.USER,auth:n},r)}}}(),r=function(){"use strict";var n=function(e,n,i){return i=i||e.channelState,i===e.channelState?(e.channelState=n,e._events=e._events||new t,e._events.trigger("onChannelStateChanged",{oldState:i,newState:n}),!0):!1},a={disconnected:0,connecting:1,connected:2};return r={channelStates:a,channelState:a.disconnected,openChannel:function(t,r){function a(i){s.serverInfo=i,r?e.isArray(r)||(r=[r]):(r=[],e.forEach(s._channels,function(e){r.push(e)}));var a=!0;!function o(i){e.forEach(i,function(r){var c=this;return s._channels[c]?(s._channel=new s._channels[c](s),s._channel.open(function(a){if(a){var u=i.slice(++r);if(!u.length)return t(e.errorMessage("Cannot open any of the specified channels"));o(u)}else n(s,s.channelStates.connected),t(null,c)}),a=!1):void 0})}(r),a&&t(e.errorMessage("None of the specified channels are supported"))}if(t=e.createCallback(t),!n(this,this.channelStates.connecting,this.channelStates.disconnected))return void t(null);var s=this;this.serverInfo?a(this.serverInfo):i.info(this.serviceUrl,function(e,i){e?(n(s,s.channelStates.disconnected),t(e,i)):a(i)})},closeChannel:function(t){if(t=e.createCallback(t),this.channelState===this.channelStates.disconnected)return t(null);var i=this;this._channel&&this._channel.close(function(e,r){return e?t(e,r):(i._channel=null,n(i,i.channelStates.disconnected),t(null))})},channelStateChanged:function(n){n=e.createCallback(n);var i=this;return this._events=this._events||new t,this._events.bind("onChannelStateChanged",function(e){n.call(i,e)}),this},_ensureConnectedState:function(){if(this.channelState===this.channelStates.disconnected)throw new Error("DeviceHive: Channel is not opened, call the .openChannel() method first");if(this.channelState===this.channelStates.connecting)throw new Error("DeviceHive: Channel has not been initialized, use .openChannel().done() to run logic after the channel is initialized")}}}(),a=function(){"use strict";var t=function(n,i){var r={timestamp:i},a=function(r,a){if(r)n._polling&&e.setTimeout(function(){t(n,i)},1e3);else{var s=null;a&&e.forEach(a,function(){var e=n._poller.resolveTimestamp(this);(!s||e>s)&&(s=e),n._poller.onData(this)}),t(n,s||i)}};n.pollRequest=n._polling&&n._poller.executePoll(r,a)},n=function(e,t){this.serviceUrl=e,this._poller=t};return n.prototype={startPolling:function(n){n=e.createCallback(n),this.stopPolling();var r=this;return i.info(this.serviceUrl,function(e,i){return e?n(e):(r._polling=!0,t(r,i.serverTimestamp),n(null))})},stopPolling:function(){this._polling=!1,this.pollRequest&&this.pollRequest.abort()}},n}(),s=function(){"use strict";var t=e.noop;return t.requestTimeout=1e4,t.prototype={_handler:e.noop,open:function(t,n){if(n=e.createCallback(n),!WebSocket)return n(e.errorMessage("WebSockets are not supported"));var i=this,r=!1;this._native=new WebSocket(t),this._native.onopen=function(e){r=!0,n(null,e)},this._native.onmessage=function(t){var n=JSON.parse(t.data);if(i._requests&&n.requestId){var r=i._requests[n.requestId];r&&(e.clearTimeout(r.timeout),n.status&&"success"==n.status?r.cb(null,n):r.cb({error:n.error}),delete i._requests[n.requestId])}else i._handler(n)},this._native.onclose=function(t){if(!r){var i=e.errorMessage("WebSocket connection has failed to open");return i.data=t,n(i)}}},close:function(t){t=e.createCallback(t),this._native.onclose=function(e){return t(null,e)},this._native.close()},message:function(e){this._handler=e},send:function(n,i,r){r=e.createCallback(r);var a=this,s={};return this._requestId=this._requestId||0,s.id=++this._requestId,s.cb=r,s.timeout=e.setTimeout(function(){s.cb(e.errorMessage("Operation timeout")),delete a._requests[s.id]},t.requestTimeout),this._requests=this._requests||{},this._requests[s.id]=s,i=i||{},i.requestId=s.id,i.action=n,this._native.send(JSON.stringify(i)),s}},t}(),o=function(){"use strict";var e=function(e){this._transport=new s,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t.deviceGuid,t.command),"command/update"==t.action&&e.trigger("onCommandUpdate",t.command),"notification/insert"==t.action&&t.deviceGuid&&t.notification&&e.trigger("onNotification",t.deviceGuid,t.notification)})};return e.prototype={open:function(e,t){this._transport.open(e+"/client",t)},close:function(e){this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n,i){this._transport.send("authenticate",{login:e,password:t,accessKey:n},i)},sendCommand:function(e,t){this._transport.send("command/insert",e,t)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)},notificationSubscribe:function(e,t){this._transport.send("notification/subscribe",e,t)},notificationUnSubscribe:function(e,t){this._transport.send("notification/unsubscribe",e,t)}},e}(),c=function(){"use strict";var e=function(e){this._transport=new s,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t.deviceGuid,t.command)})};return e.prototype={open:function(e,t){return this._transport.open(e+"/device",t)},close:function(e){return this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n){this._transport.send("authenticate",{deviceId:e,deviceKey:t},n)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)}},e}(),u=function(){"use strict";return u=function(n){this._hive=n,this._handler=e.noop,this._events=new t,this.deviceIds=[];var r=this;this._lp=new a(this._hive.serviceUrl,{executePoll:function(e,t){return r._hive._executeApi(i.pollCommands,[e,t])},resolveTimestamp:function(e){return e.timestamp},onData:function(e){r._events.trigger("onCommandInsert",r._hive.deviceId,e)}})},u.prototype={open:function(t){return(t=e.createCallback(t))(null)},close:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},subscribe:function(t){return t=e.createCallback(t),this._lp.startPolling(t)},unsubscribe:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},sendNotification:function(t,n){return n=e.createCallback(n),this._hive._executeApi(i.insertNotification,[t.notification,n])},updateCommand:function(t,n){return n=e.createCallback(n),this._hive._executeApi(i.updateCommand,[t.commandId,t.command,n])}},u}(),h=function(){"use strict";var n=function(e){this._hive=e,this._events=new t};return n.prototype={open:function(t){function n(e){return e?t(e):void(r._hive.auth.accessKey?r._wsApi.authenticate(null,null,r._hive.auth.accessKey,t):r._wsApi.authenticate(r._hive.auth.deviceId,r._hive.auth.deviceKey,t))}t=e.createCallback(t);var i=this._hive.serverInfo.webSocketServerUrl;if(!i)return void t(e.errorMessage("Open channel failed. Cannot get web socket server url"));var r=this;this._wsApi=r._hive.auth.accessKey?new o(r._events):new c(r._events),this._wsApi.open(i,n)},close:function(t){t=e.createCallback(t),this._wsApi.close(t)},subscribe:function(t){t=e.createCallback(t);var n=this;this._wsApi.commandSubscribe({deviceGuids:[this._hive.deviceId]},function(e,i){return e||(n._sub=i.subscriptionId),t(e)})},unsubscribe:function(t){t=e.createCallback(t),this._wsApi.commandUnSubscribe({subscriptionId:this._sub},function(e){return e||(self._sub=null),t(e)})},sendNotification:function(t,n){n=e.createCallback(n),this._wsApi.sendNotification(t,n)},updateCommand:function(t,n){n=e.createCallback(n),this._wsApi.updateCommand(t,n)}},n}(),l=function(){"use strict";var t=function(t,n,i){this.serviceUrl=t,this.deviceId=n,this.auth={},e.isGuid(i)?(this.auth.deviceId=n,this.auth.deviceKey=i):this.auth.accessKey=i};t.prototype=r,t.constructor=t,t.prototype.getDevice=function(t){return t=e.createCallback(t),this._executeApi(i.getDevice,[t])},t.prototype.registerDevice=function(t,n){return n=e.createCallback(n),t.key=this.auth.deviceKey,this._executeApi(i.registerDevice,[t,n])},t.prototype.updateDevice=function(t,n){return n=e.createCallback(n),this._executeApi(i.registerDevice,[t,n])};var n=t.prototype.openChannel;return t.prototype.openChannel=function(t,i){t=e.createCallback(t);var r=this;n.call(this,function(n,i){return n?t(n,i):(r._channel._events.bind("onCommandInsert",function(t,n){n.update=function(t,i){if(!t||!t.status)return i(e.errorMessage("Command status must be specified"));var a={};return a.commandId=n.id,a.command=t||{},a.deviceGuid=r.deviceId,r._channel.updateCommand(a,i)},r._events.trigger("onCommand",n)}),t(n,i))},i)},t.prototype.subscribe=function(t){return t=e.createCallback(t),this._ensureConnectedState(),this._channel.subscribe(t)},t.prototype.unsubscribe=function(t){return t=e.createCallback(t),this._ensureConnectedState(),this._channel.unsubscribe(t)},t.prototype.sendNotification=function(t,n,i){return i=e.createCallback(i),this._ensureConnectedState(),this._channel.sendNotification({notification:{notification:t,parameters:n},deviceGuid:this.deviceId},i)},t.prototype.command=function(t){t=e.createCallback(t);var n=this;return this._events.bind("onCommand",function(e){t.call(n,e)}),this},t.prototype._executeApi=function(e,t){var n=[this.serviceUrl,this.auth,this.deviceId].concat(t);return e.apply(null,n)},t.prototype._channels={},t.prototype._channels.websocket=h,t.prototype._channels.longpolling=u,t}();return l});