!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.DHJQuery=t()}(this,function(){var e=function(){"use strict";var e={isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},inArray:function(e,t,n){if(t){if(Array.prototype.indexOf)return t.indexOf(e,n);var r=t.length,i=+n||0;if(!r||i>=r)return-1;for(i=0>i?Math.max(0,r+i):i;r>i;i++)if(i in t&&t[i]===e)return i;return-1}},forEach:function(e,t){var n;if(this.isArray(e)){var r=e.length;for(n=0;r>n&&t.call(e[n],n,e[n])!==!1;n++);}else for(n in e)if(e.hasOwnProperty(n)&&t.call(e[n],n,e[n])===!1)break;return e},toArray:function(e){if(!e)return null;for(var t=[],n=0,r=e.length;r>n;n++)t.push(e[n]);return t},parseDate:function(e){return new Date(e.substring(0,4),parseInt(e.substring(5,7),10)-1,e.substring(8,10),e.substring(11,13),e.substring(14,16),e.substring(17,19),e.substring(20,23))},formatDate:function(t){if(e.isString(t))return t;if("[object Date]"!==Object.prototype.toString.call(t))throw new Error("Invalid object type");var n=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return t.getUTCFullYear()+"-"+n(t.getUTCMonth()+1)+"-"+n(t.getUTCDate())+"T"+n(t.getUTCHours())+":"+n(t.getUTCMinutes())+":"+n(t.getUTCSeconds())+"."+n(t.getUTCMilliseconds(),3)},encodeBase64:function(e){var t,n,r,i,a,o,s,c,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,d=0,l="",f=[];if(!e)return e;do t=e.charCodeAt(h++),n=e.charCodeAt(h++),r=e.charCodeAt(h++),c=t<<16|n<<8|r,i=c>>18&63,a=c>>12&63,o=c>>6&63,s=63&c,f[d++]=u.charAt(i)+u.charAt(a)+u.charAt(o)+u.charAt(s);while(h<e.length);l=f.join("");var p=e.length%3;return(p?l.slice(0,p-3):l)+"===".slice(p||3)},noop:function(){},createCallback:function(e){return e&&"[object Function]"===Object.prototype.toString.call(e)?e:this.noop},isGuid:function(e){return e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},serializeQuery:function(e){var t,n,r="";for(t in e)e.hasOwnProperty(t)&&(""!=r&&(r+="&"),n=e[t],n=null==n?"":n,r+=encodeURIComponent(t)+"="+encodeURIComponent(n));return r},makeUrl:function(t){var n=t.method,r=t.url,i=t.data;return"GET"===n&&i&&(i=e.serializeQuery(i),i&&(r+=(-1!=r.indexOf("?")?"&":"?")+i)),r},serverErrorMessage:function(e){var t="DeviceHive server error";if(e.responseText)try{t+=" - "+JSON.parse(e.responseText).message}catch(n){t+=" - "+e.responseText}return{error:t}},errorMessage:function(e){return{error:"DeviceHive error: "+e}},setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)}};return e}(),t=function(){"use strict";var t=function(){};return t.prototype={bind:function(e,t,n){this._handlers||(this._handlers={});var r=this._handlers[e]||(this._handlers[e]=[]);return r.push({callback:t,context:n||this}),this},unbind:function(t,n){if(!t&&!n)return this._handlers=null,this;var r=this._handlers[t];if(!r)return this;if(!n)return delete this._handlers[t],this;var i=[];return e.forEach(r,function(e,t){n&&n!==t.callback&&i.push(t)}),i.length?this._handlers[t]=i:delete this._handlers[t],this},trigger:function(t){if(!this._handlers)return this;var n=e.toArray(arguments).slice(1),r=this._handlers[t];return r&&this._triggerEvents(r,n),this},_triggerEvents:function(t,n){e.forEach(t,function(e,t){t.callback.apply(t.context,n)})}},t}(),n=function(){"use strict";var t=e.noop();if(t="undefined"!=typeof XMLHttpRequest?function(){return new XMLHttpRequest}:function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}},!t())throw new Error("DeviceHive: XMLHttpRequest is not available");return{send:function(n,r){n.method=n.method||"GET",r=e.createCallback(r);var i=t(),a=n.headers,o=e.makeUrl(n),s=n.method;if(i.open(s,o,!0),("POST"==s||"PUT"==s)&&(i.setRequestHeader("Content-Type","application/json"),n.data=JSON.stringify(n.data)),i.onreadystatechange=function(){var t,n;if(4===i.readyState){t=i.status&&i.status>=200&&i.status<300||304===i.status,t||(n=e.serverErrorMessage(i));var a=i.responseText?JSON.parse(i.responseText):null;return r(n,a)}},a)for(var c in a)void 0!==a[c]&&i.setRequestHeader(c,a[c]);return i.send(n.data||void 0),{abort:function(){i.abort()}}}}}(),r=function(){"use strict";var t={USER:1,KEY:2,DEVICE:4},r=function(e,t){return(e&t)==t},i=function(n,i){var a=i.authTypes,o=i.auth;if(n.headers=i.headers||{},a){if(!o)throw new Error("Authentication parameters must be specified for this endpoint. Endpoint auth code: "+a);if(r(a,t.KEY)&&o.accessKey)n.headers.Authorization="Bearer "+o.accessKey;else if(r(a,t.DEVICE)&&e.isGuid(o.deviceId)&&e.isGuid(o.deviceKey))n.headers["Auth-DeviceID"]=o.deviceId,n.headers["Auth-DeviceKey"]=o.deviceKey;else{if(!r(a,t.USER))throw new Error("Invalid authentication parameters. Endpoint auth code: "+a);n.headers.Authorization="Basic "+e.encodeBase64(o.login+":"+o.password)}}},a=function(e,t){var r={method:e.method,url:e.base+e.relative,data:e.data};return i(r,e,t),n.send(r,t)};return{info:function(e,t){return a({base:e,relative:"/info",method:"GET"},t)},getAccessKeys:function(e,n,r,i){return a({base:e,relative:"/user/"+r+"/accesskey",method:"GET",authTypes:t.USER,auth:n},i)},getAccessKey:function(e,n,r,i,o){return a({base:e,relative:"/user/"+r+"/accesskey/"+r,method:"GET",authTypes:t.USER,auth:n},o)},insertAccessKey:function(e,n,r,i,o){return a({base:e,relative:"/user/"+r+"/accesskey",data:i,method:"POST",authTypes:t.USER,auth:n},o)},updateAccessKey:function(e,n,r,i,o,s){return a({base:e,relative:"/user/"+r+"/accesskey/"+i,data:o,method:"PUT",authTypes:t.USER,auth:n},s)},deleteAccessKey:function(e,n,r,i,o){return a({base:e,relative:"/user/"+r+"/accesskey/"+i,method:"DELETE",authTypes:t.USER,auth:n},o)},getDevices:function(e,n,r,i){return a({base:e,relative:"/device",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getDevice:function(e,n,r,i){return a({base:e,relative:"/device/"+r,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},i)},getEquipmentState:function(e,n,r,i){return a({base:e,relative:"/device/"+r+"/equipment",method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},registerDevice:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r,method:"PUT",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},getDeviceClass:function(e,n,r,i){return a({base:e,relative:"/device/class/"+r,method:"GET",authTypes:t.USER,auth:n},i)},getCommands:function(n,r,i,o,s){return o&&o.start&&(o.start=e.formatDate(o.start)),o&&o.end&&(o.end=e.formatDate(o.end)),a({base:n,relative:"/device/"+i+"/command",method:"GET",data:o,authTypes:t.USER|t.KEY|t.DEVICE,auth:r},s)},getCommand:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/command/"+i,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},insertCommand:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/command",method:"POST",data:i,authTypes:t.USER|t.KEY,auth:n},o)},updateCommand:function(e,n,r,i,o,s){return a({base:e,relative:"/device/"+r+"/command/"+i,method:"PUT",data:o,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},s)},pollCommands:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/command/poll",method:"GET",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},pollManyCommands:function(e,n,r,i){return a({base:e,relative:"/device/command/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},waitCommandResult:function(e,n,r,i,o,s){return a({base:e,relative:"/device/"+r+"/command/"+i+"/poll",method:"GET",data:o,authTypes:t.USER|t.KEY,auth:n},s)},getNotifications:function(n,r,i,o,s){return o&&o.start&&(o.start=e.formatDate(o.start)),o&&o.end&&(o.end=e.formatDate(o.end)),a({base:n,relative:"/device/"+i+"/notification",method:"GET",data:o,authTypes:t.USER|t.KEY,auth:r},s)},getNotification:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/notification/"+i,method:"GET",authTypes:t.USER|t.KEY,auth:n},o)},insertNotification:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/notification",method:"POST",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},pollNotifications:function(e,n,r,i,o){return a({base:e,relative:"/device/"+r+"/notification/poll",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},o)},pollManyNotifications:function(e,n,r,i){return a({base:e,relative:"/device/notification/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetworks:function(e,n,r,i){return a({base:e,relative:"/network",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetwork:function(e,n,r,i){return a({base:e,relative:"/network/"+r,method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},insertNetwork:function(e,n,r,i){return a({base:e,relative:"/network",method:"POST",data:r,authTypes:t.USER,auth:n},i)},updateNetwork:function(e,n,r,i,o){return a({base:e,relative:"/network/"+r,method:"PUT",data:i,authTypes:t.USER,auth:n},o)},deleteNetwork:function(e,n,r,i){return a({base:e,relative:"/network/"+r,method:"DELETE",authTypes:t.USER,auth:n},i)},getCurrentUser:function(e,n,r){return a({base:e,relative:"/user/current",method:"GET",authTypes:t.USER,auth:n},r)},updateCurrentUser:function(e,n,r,i){return a({base:e,relative:"/user/current",method:"PUT",data:r,authTypes:t.USER,auth:n},i)}}}(),i=function(){"use strict";var n=function(e,n,r){return r=r||e.channelState,r===e.channelState?(e.channelState=n,e._events=e._events||new t,e._events.trigger("onChannelStateChanged",{oldState:r,newState:n}),!0):!1},a={disconnected:0,connecting:1,connected:2};return i={channelStates:a,channelState:a.disconnected,openChannel:function(t,i){function a(r){o.serverInfo=r,i?e.isArray(i)||(i=[i]):(i=[],e.forEach(o._channels,function(e){i.push(e)}));var a=!0;!function s(r){e.forEach(r,function(i){var c=this;return o._channels[c]?(o._channel=new o._channels[c](o),o._channel.open(function(a){if(a){var u=r.slice(++i);if(!u.length)return t(e.errorMessage("Cannot open any of the specified channels"));s(u)}else n(o,o.channelStates.connected),t(null,c)}),a=!1):void 0})}(i),a&&t(e.errorMessage("None of the specified channels are supported"))}if(t=e.createCallback(t),!n(this,this.channelStates.connecting,this.channelStates.disconnected))return void t(null);var o=this;this.serverInfo?a(this.serverInfo):r.info(this.serviceUrl,function(e,r){e?(n(o,o.channelStates.disconnected),t(e,r)):a(r)})},closeChannel:function(t){if(t=e.createCallback(t),this.channelState===this.channelStates.disconnected)return t(null);var r=this;this._channel&&this._channel.close(function(e,i){return e?t(e,i):(r._channel=null,n(r,r.channelStates.disconnected),t(null))})},channelStateChanged:function(n){n=e.createCallback(n);var r=this;return this._events=this._events||new t,this._events.bind("onChannelStateChanged",function(e){n.call(r,e)}),this},_ensureConnectedState:function(){if(this.channelState===this.channelStates.disconnected)throw new Error("DeviceHive: Channel is not opened, call the .openChannel() method first");if(this.channelState===this.channelStates.connecting)throw new Error("DeviceHive: Channel has not been initialized, use .openChannel().done() to run logic after the channel is initialized")}}}(),a=function(){"use strict";var t=function(n,r){var i={timestamp:r},a=function(i,a){if(i)n._polling&&e.setTimeout(function(){t(n,r)},1e3);else{var o=null;a&&e.forEach(a,function(){var e=n._poller.resolveTimestamp(this);(!o||e>o)&&(o=e),n._poller.onData(this)}),t(n,o||r)}};n.pollRequest=n._polling&&n._poller.executePoll(i,a)},n=function(e,t){this.serviceUrl=e,this._poller=t};return n.prototype={startPolling:function(n){n=e.createCallback(n),this.stopPolling();var i=this;return r.info(this.serviceUrl,function(e,r){return e?n(e):(i._polling=!0,t(i,r.serverTimestamp),n(null))})},stopPolling:function(){this._polling=!1,this.pollRequest&&this.pollRequest.abort()}},n}(),o=function(){"use strict";var t=e.noop;return t.requestTimeout=1e4,t.prototype={_handler:e.noop,open:function(t,n){if(n=e.createCallback(n),!WebSocket)return n(e.errorMessage("WebSockets are not supported"));var r=this,i=!1;this._native=new WebSocket(t),this._native.onopen=function(e){i=!0,n(null,e)},this._native.onmessage=function(t){var n=JSON.parse(t.data);if(r._requests&&n.requestId){var i=r._requests[n.requestId];i&&(e.clearTimeout(i.timeout),n.status&&"success"==n.status?i.cb(null,n):i.cb({error:n.error}),delete r._requests[n.requestId])}else r._handler(n)},this._native.onclose=function(t){if(!i){var r=e.errorMessage("WebSocket connection has failed to open");return r.data=t,n(r)}}},close:function(t){t=e.createCallback(t),this._native.onclose=function(e){return t(null,e)},this._native.close()},message:function(e){this._handler=e},send:function(n,r,i){i=e.createCallback(i);var a=this,o={};return this._requestId=this._requestId||0,o.id=++this._requestId,o.cb=i,o.timeout=e.setTimeout(function(){o.cb(e.errorMessage("Operation timeout")),delete a._requests[o.id]},t.requestTimeout),this._requests=this._requests||{},this._requests[o.id]=o,r=r||{},r.requestId=o.id,r.action=n,this._native.send(JSON.stringify(r)),o}},t}(),s=function(){"use strict";var e=function(e){this._transport=new o,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t.deviceGuid,t.command),"command/update"==t.action&&e.trigger("onCommandUpdate",t.command),"notification/insert"==t.action&&t.deviceGuid&&t.notification&&e.trigger("onNotification",t.deviceGuid,t.notification)})};return e.prototype={open:function(e,t){this._transport.open(e+"/client",t)},close:function(e){this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n,r){this._transport.send("authenticate",{login:e,password:t,accessKey:n},r)},sendCommand:function(e,t){this._transport.send("command/insert",e,t)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)},notificationSubscribe:function(e,t){this._transport.send("notification/subscribe",e,t)},notificationUnSubscribe:function(e,t){this._transport.send("notification/unsubscribe",e,t)}},e}(),c=function(){"use strict";var e=function(e){this._transport=new o,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t.deviceGuid,t.command)})};return e.prototype={open:function(e,t){return this._transport.open(e+"/device",t)},close:function(e){return this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n){this._transport.send("authenticate",{deviceId:e,deviceKey:t},n)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)}},e}(),u=function(){"use strict";return u=function(n){this._hive=n,this._handler=e.noop,this._events=new t,this.deviceIds=[];var i=this;this._lp=new a(this._hive.serviceUrl,{executePoll:function(e,t){return i._hive._executeApi(r.pollCommands,[e,t])},resolveTimestamp:function(e){return e.timestamp},onData:function(e){i._events.trigger("onCommandInsert",i._hive.deviceId,e)}})},u.prototype={open:function(t){return(t=e.createCallback(t))(null)},close:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},subscribe:function(t){return t=e.createCallback(t),this._lp.startPolling(t)},unsubscribe:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},sendNotification:function(t,n){return n=e.createCallback(n),this._hive._executeApi(r.insertNotification,[t.notification,n])},updateCommand:function(t,n){return n=e.createCallback(n),this._hive._executeApi(r.updateCommand,[t.commandId,t.command,n])}},u}(),h=function(){"use strict";var n=function(e){this._hive=e,this._events=new t};return n.prototype={open:function(t){function n(e){return e?t(e):void(i._hive.auth.accessKey?i._wsApi.authenticate(null,null,i._hive.auth.accessKey,t):i._wsApi.authenticate(i._hive.auth.deviceId,i._hive.auth.deviceKey,t))}t=e.createCallback(t);var r=this._hive.serverInfo.webSocketServerUrl;if(!r)return void t(e.errorMessage("Open channel failed. Cannot get web socket server url"));var i=this;this._wsApi=i._hive.auth.accessKey?new s(i._events):new c(i._events),this._wsApi.open(r,n)},close:function(t){t=e.createCallback(t),this._wsApi.close(t)},subscribe:function(t){t=e.createCallback(t);var n=this;this._wsApi.commandSubscribe({deviceGuids:[this._hive.deviceId]},function(e,r){return e||(n._sub=r.subscriptionId),t(e)})},unsubscribe:function(t){t=e.createCallback(t),this._wsApi.commandUnSubscribe({subscriptionId:this._sub},function(e){return e||(self._sub=null),t(e)})},sendNotification:function(t,n){n=e.createCallback(n),this._wsApi.sendNotification(t,n)},updateCommand:function(t,n){n=e.createCallback(n),this._wsApi.updateCommand(t,n)}},n}(),d=function(){"use strict";var t=function(t,n,r){this.serviceUrl=t,this.deviceId=n,this.auth={},e.isGuid(r)?(this.auth.deviceId=n,this.auth.deviceKey=r):this.auth.accessKey=r};t.prototype=i,t.constructor=t,t.prototype.getDevice=function(t){return t=e.createCallback(t),this._executeApi(r.getDevice,[t])},t.prototype.registerDevice=function(t,n){return n=e.createCallback(n),t.key=this.auth.deviceKey,this._executeApi(r.registerDevice,[t,n])},t.prototype.updateDevice=function(t,n){return n=e.createCallback(n),this._executeApi(r.registerDevice,[t,n])};var n=t.prototype.openChannel;return t.prototype.openChannel=function(t,r){t=e.createCallback(t);var i=this;n.call(this,function(n,r){return n?t(n,r):(i._channel._events.bind("onCommandInsert",function(t,n){n.update=function(t,r){if(!t||!t.status)return r(e.errorMessage("Command status must be specified"));var a={};return a.commandId=n.id,a.command=t||{},a.deviceGuid=i.deviceId,i._channel.updateCommand(a,r)},i._events.trigger("onCommand",n)}),t(n,r))},r)},t.prototype.subscribe=function(t){return t=e.createCallback(t),this._ensureConnectedState(),this._channel.subscribe(t)},t.prototype.unsubscribe=function(t){return t=e.createCallback(t),this._ensureConnectedState(),this._channel.unsubscribe(t)},t.prototype.sendNotification=function(t,n,r){return r=e.createCallback(r),this._ensureConnectedState(),this._channel.sendNotification({notification:{notification:t,parameters:n},deviceGuid:this.deviceId},r)},t.prototype.command=function(t){t=e.createCallback(t);var n=this;return this._events.bind("onCommand",function(e){t.call(n,e)}),this},t.prototype._executeApi=function(e,t){var n=[this.serviceUrl,this.auth,this.deviceId].concat(t);return e.apply(null,n)},t.prototype._channels={},t.prototype._channels.websocket=h,t.prototype._channels.longpolling=u,t}(),l=function(e){"use strict";var t=function(t,n){return function(){var r=e.Deferred(),i=Array.prototype.slice.call(arguments);return n="undefined"!=typeof n?n:i.length,i.splice(n,0,function(e,t){e?r.reject(e):r.resolve(t)}),e.extend({},t.apply(this,i),r.promise())}};return{wrapWithDeferredLast:function(e){return t(e)},wrapWithDeferredFirst:function(e){return t(e,0)}}}(jQuery),f=function(e){"use strict";var t=function(e,t,n){d.call(this,e,t,n)},n=d.prototype.command;return e.extend(t.prototype,d.prototype,{getDevice:l.wrapWithDeferredLast(d.prototype.getDevice),registerDevice:l.wrapWithDeferredLast(d.prototype.registerDevice),updateDevice:l.wrapWithDeferredLast(d.prototype.updateDevice),subscribe:l.wrapWithDeferredLast(d.prototype.subscribe),unsubscribe:l.wrapWithDeferredLast(d.prototype.unsubscribe),sendNotification:l.wrapWithDeferredLast(d.prototype.sendNotification),command:function(e){var t=function(t){var n=t.update;t.update=l.wrapWithDeferredLast(n),e(t)};return n.call(this,t)},openChannel:l.wrapWithDeferredFirst(d.prototype.openChannel),closeChannel:l.wrapWithDeferredLast(d.prototype.closeChannel)}),e.dhDevice=function(e,n,r){return new t(e,n,r)}}(jQuery);return f});